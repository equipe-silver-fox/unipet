<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Unipet - Login</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../public/style.css" />
    <style>
      body {
        background: #23272a;
        color: rgb(0, 0, 0);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: "Poppins", sans-serif;
      }
      .logo {
        text-align: center;
        margin-bottom: 30px;
      }
      .logo img {
        width: 295px;
        margin-bottom: -110px;
      }
      .logo h1 {
        font-weight: 700;
        font-size: 96px;
        color: white;
      }

      .form-control {
        background-color: #ffffff; /* fundo escuro do input */
        border: none;
        border-radius: 20px;
        padding: 14px;
        color: #000000; /* texto digitado branco */
      }

      .form-control::placeholder {
        color: #aaaaaa; /* placeholder cinza claro */
      }

      .btn-primary {
        background-color: #7289da;
        border: none;
        border-radius: 25px;
        padding: 10px 0;
        font-weight: 600;
        margin-top: 100px;
      }

      .text-secondary {
        color: #7289da !important;
      }

      .btn-toggle-password {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 5px;
      }

      .btn-toggle-password:hover {
        color: #7289da;
      }

      .position-relative {
        position: relative;
      }

      .senha-forca {
        height: 4px;
        border-radius: 2px;
        transition: all 0.3s;
      }

      .senha-fraca { background: #ef4444; width: 33%; }
      .senha-media { background: #f59e0b; width: 66%; }
      .senha-forte { background: #10b981; width: 100%; }
    </style>
  </head>

  <body>
    <div class="logo">
      <img src="../../public/img/logo.png" alt="Unipet Logo" />
      <h1>UniPet</h1>
    </div>

    <div class="container" style="max-width: 330px">
      <form id="registroForm">
        <div class="mb-3">
          <input 
            type="text" 
            class="form-control" 
            id="nomeInput"
            placeholder="Nome" 
            required 
            minlength="3"
            maxlength="50"
            pattern="[A-Za-z√Ä-√ø ]+"
            title="Nome deve conter apenas letras"
          />
        </div>
        <div class="mb-3">
          <input
            type="email"
            class="form-control"
            id="emailInput"
            placeholder="Email"
            required
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
            title="Digite um email v√°lido"
          />
        </div>
        <div class="mb-3 position-relative">
          <input
            type="password"
            class="form-control"
            id="senhaInput"
            placeholder="Senha (m√≠n. 8 caracteres)"
            required
            minlength="8"
          />
          <button type="button" class="btn-toggle-password" id="togglePassword">
            <i class="fas fa-eye"></i>
          </button>
          <div id="senhaForca" class="senha-forca mt-1"></div>
        </div>
        <div class="mb-3 position-relative">
          <input
            type="password"
            class="form-control"
            id="confirmarSenhaInput"
            placeholder="Confirmar Senha"
            required
            minlength="8"
          />
          <button type="button" class="btn-toggle-password" id="toggleConfirmarPassword">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div id="errorMsg" class="text-danger text-center mb-2" style="display: none; font-size: 14px;"></div>
        <button type="submit" class="btn btn-primary w-100 mb-3" id="btnCadastrar">
          CADASTRAR
        </button>
      </form>

      <div class="text-center">
        <p style="color: #bbb">
          JA POSSUI UMA CONTA?
          <a href="login.html" class="text-secondary fw-semibold">ENTRAR</a>
        </p>
      </div>
    </div>

    <!-- ü¶Æ Menu de Acessibilidade -->
    <button
      id="btnAcessibilidade"
      class="btn-acessibilidade"
      aria-label="Abrir menu de acessibilidade"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        fill="currentColor"
        class="bi bi-universal-access-circle"
        viewBox="0 0 16 16"
      >
        <path
          d="M8 4.143A1.071 1.071 0 1 0 8 2a1.071 1.071 0 0 0 0 2.143m-4.668 1.47 3.24.316v2.5l-.323 4.585A.383.383 0 0 0 7 13.14l.826-4.017c.045-.18.301-.18.346 0L9 13.139a.383.383 0 0 0 .752-.125L9.43 8.43v-2.5l3.239-.316a.38.38 0 0 0-.047-.756H3.379a.38.38 0 0 0-.047.756Z"
        />
        <path
          d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0M1 8a7 7 0 1 1 14 0A7 7 0 0 1 1 8"
        />
      </svg>
    </button>

    <div id="menuAcessibilidade" class="menu-acessibilidade hidden">
      <h3>Acessibilidade</h3>
      <button id="aumentarFonte">Aumentar Fonte</button>
      <button id="diminuirFonte">Diminuir Fonte</button>
      <button id="altoContraste">Alto Contraste</button>
      <button id="resetarAcessibilidade">Resetar</button>
    </div>

    <script
      src="https://kit.fontawesome.com/a2d04f1e56.js"
      crossorigin="anonymous"
    ></script>
    <script src="../script.js"></script>
    <script>
      const API_URL = "http://localhost:3000";
      const registroForm = document.getElementById("registroForm");
      const nomeInput = document.getElementById("nomeInput");
      const emailInput = document.getElementById("emailInput");
      const senhaInput = document.getElementById("senhaInput");
      const confirmarSenhaInput = document.getElementById("confirmarSenhaInput");
      const errorMsg = document.getElementById("errorMsg");
      const btnCadastrar = document.getElementById("btnCadastrar");
      const senhaForca = document.getElementById("senhaForca");
      const togglePassword = document.getElementById("togglePassword");
      const toggleConfirmarPassword = document.getElementById("toggleConfirmarPassword");

      // Toggle mostrar/ocultar senha
      togglePassword.addEventListener('click', () => {
        const type = senhaInput.type === 'password' ? 'text' : 'password';
        senhaInput.type = type;
        togglePassword.innerHTML = type === 'password' 
          ? '<i class="fas fa-eye"></i>' 
          : '<i class="fas fa-eye-slash"></i>';
      });

      toggleConfirmarPassword.addEventListener('click', () => {
        const type = confirmarSenhaInput.type === 'password' ? 'text' : 'password';
        confirmarSenhaInput.type = type;
        toggleConfirmarPassword.innerHTML = type === 'password' 
          ? '<i class="fas fa-eye"></i>' 
          : '<i class="fas fa-eye-slash"></i>';
      });

      // Sanitizar input
      function sanitizeInput(input) {
        const div = document.createElement('div');
        div.textContent = input;
        return div.innerHTML.trim();
      }

      // Validar email
      function validarEmail(email) {
        const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return regex.test(email);
      }

      // Validar for√ßa da senha
      function validarForcaSenha(senha) {
        let forca = 0;
        if (senha.length >= 8) forca++;
        if (senha.length >= 12) forca++;
        if (/[a-z]/.test(senha) && /[A-Z]/.test(senha)) forca++;
        if (/[0-9]/.test(senha)) forca++;
        if (/[^a-zA-Z0-9]/.test(senha)) forca++;
        return forca;
      }

      // Atualizar indicador de for√ßa da senha
      senhaInput.addEventListener('input', () => {
        const senha = senhaInput.value;
        const forca = validarForcaSenha(senha);
        
        senhaForca.className = 'senha-forca mt-1';
        if (senha.length === 0) {
          senhaForca.className = 'senha-forca mt-1';
        } else if (forca <= 2) {
          senhaForca.classList.add('senha-fraca');
        } else if (forca <= 3) {
          senhaForca.classList.add('senha-media');
        } else {
          senhaForca.classList.add('senha-forte');
        }
      });

      registroForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMsg.style.display = 'none';

        const nome = sanitizeInput(nomeInput.value);
        const email = sanitizeInput(emailInput.value);
        const senha = senhaInput.value;
        const confirmarSenha = confirmarSenhaInput.value;

        // Valida√ß√µes
        if (nome.length < 3) {
          errorMsg.textContent = 'Nome deve ter no m√≠nimo 3 caracteres.';
          errorMsg.style.display = 'block';
          return;
        }

        if (!validarEmail(email)) {
          errorMsg.textContent = 'Por favor, insira um email v√°lido.';
          errorMsg.style.display = 'block';
          return;
        }

        if (senha.length < 8) {
          errorMsg.textContent = 'A senha deve ter no m√≠nimo 8 caracteres.';
          errorMsg.style.display = 'block';
          return;
        }

        if (validarForcaSenha(senha) < 2) {
          errorMsg.textContent = 'Senha muito fraca. Use letras, n√∫meros e caracteres especiais.';
          errorMsg.style.display = 'block';
          return;
        }

        if (senha !== confirmarSenha) {
          errorMsg.textContent = 'As senhas n√£o coincidem.';
          errorMsg.style.display = 'block';
          return;
        }

        // Verificar senhas comuns
        const senhasComuns = ['12345678', 'password', 'senha123', '11111111', 'abc12345'];
        if (senhasComuns.includes(senha.toLowerCase())) {
          errorMsg.textContent = 'Esta senha √© muito comum. Escolha outra.';
          errorMsg.style.display = 'block';
          return;
        }

        btnCadastrar.disabled = true;
        btnCadastrar.textContent = 'CADASTRANDO...';

        try {
          const res = await fetch(`${API_URL}/usuarios`, {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest"
            },
            body: JSON.stringify({ nome, email, senha }),
          });

          if (!res.ok) {
            const erro = await res.json();
            errorMsg.textContent = erro.erro || 'Erro ao cadastrar!';
            errorMsg.style.display = 'block';
            return;
          }

          const usuario = await res.json();
          alert(`Cadastro realizado com sucesso! Bem-vindo, ${usuario.nome}`);
          window.location.href = "login.html";
        } catch (err) {
          console.error(err);
          errorMsg.textContent = 'Erro na conex√£o com o servidor.';
          errorMsg.style.display = 'block';
        } finally {
          btnCadastrar.disabled = false;
          btnCadastrar.textContent = 'CADASTRAR';
        }
      });
    </script>
  </body>
</html>
