<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Unipet - Login</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../public/style.css" />
    <style>
      body {
        background: #23272a;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: "Poppins", sans-serif;
      }

      .logo {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo img {
        width: 295px;
        margin-bottom: -110px;
      }

      .logo h1 {
        font-weight: 700;
        font-size: 96px;
        color: white;
      }

      .form-control {
        background-color: #ffffff;
        border: none;
        border-radius: 20px;
        padding: 14px;
        color: #050505;
      }

      .form-control::placeholder {
        color: black;
      }

      .btn-primary {
        background-color: #7289da;
        border: none;
        border-radius: 25px;
        padding: 10px 0;
        font-weight: 600;
        margin-top: 100px;
      }

      .text-secondary {
        color: #7289da !important;
      }

      .acessibilidade {
        position: fixed;
        bottom: 15px;
      }

      .btn-toggle-password {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 5px;
      }

      .btn-toggle-password:hover {
        color: #7289da;
      }

      .position-relative {
        position: relative;
      }
    </style>
  </head>

  <body>
    <div class="logo">
      <img src="../../public/img/logo.png" alt="Unipet Logo" />
      <h1>UniPet</h1>
    </div>

    <div class="container" style="max-width: 330px">
      <form id="loginForm">
        <div class="mb-3">
          <input 
            type="email" 
            class="form-control" 
            id="emailInput"
            placeholder="Email" 
            required 
            autocomplete="email"
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
            title="Digite um email v√°lido"
          />
        </div>
        <div class="mb-3 position-relative">
          <input
            type="password"
            class="form-control"
            id="senhaInput"
            placeholder="Senha"
            required
            minlength="6"
            autocomplete="current-password"
          />
          <button type="button" class="btn-toggle-password" id="togglePassword">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div id="errorMsg" class="text-danger text-center mb-2" style="display: none; font-size: 14px;"></div>
        <button type="submit" class="btn btn-primary w-100 mb-3" id="btnLogin">ENTRAR</button>
      </form>

      <div class="text-center">
        <p style="color: #bbb">
          N√ÉO POSSUI UMA CONTA?
          <a href="registrar.html" class="text-secondary fw-semibold"
            >CADASTRE-SE</a
          >
        </p>
      </div>
    </div>
    <!-- ü¶Æ Menu de Acessibilidade -->
    <button
      id="btnAcessibilidade"
      class="btn-acessibilidade"
      aria-label="Abrir menu de acessibilidade"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        fill="currentColor"
        class="bi bi-universal-access-circle"
        viewBox="0 0 16 16"
      >
        <path
          d="M8 4.143A1.071 1.071 0 1 0 8 2a1.071 1.071 0 0 0 0 2.143m-4.668 1.47 3.24.316v2.5l-.323 4.585A.383.383 0 0 0 7 13.14l.826-4.017c.045-.18.301-.18.346 0L9 13.139a.383.383 0 0 0 .752-.125L9.43 8.43v-2.5l3.239-.316a.38.38 0 0 0-.047-.756H3.379a.38.38 0 0 0-.047.756Z"
        />
        <path
          d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0M1 8a7 7 0 1 1 14 0A7 7 0 0 1 1 8"
        />
      </svg>
    </button>

    <div id="menuAcessibilidade" class="menu-acessibilidade hidden">
      <h3>Acessibilidade</h3>
      <button id="aumentarFonte">Aumentar Fonte</button>
      <button id="diminuirFonte">Diminuir Fonte</button>
      <button id="altoContraste">Alto Contraste</button>
      <button id="resetarAcessibilidade">Resetar</button>
    </div>

    <script
      src="https://kit.fontawesome.com/a2d04f1e56.js"
      crossorigin="anonymous"
    ></script>
    <script src="../script.js"></script>
    <script>
      const API_URL = "http://localhost:3000";
      const loginForm = document.getElementById("loginForm");
      const emailInput = document.getElementById("emailInput");
      const senhaInput = document.getElementById("senhaInput");
      const errorMsg = document.getElementById("errorMsg");
      const btnLogin = document.getElementById("btnLogin");
      const togglePassword = document.getElementById("togglePassword");

      // Limite de tentativas de login
      let tentativas = parseInt(localStorage.getItem('loginAttempts') || '0');
      let ultimaTentativa = parseInt(localStorage.getItem('lastAttempt') || '0');
      const TEMPO_BLOQUEIO = 5 * 60 * 1000; // 5 minutos
      const MAX_TENTATIVAS = 5;

      // Toggle mostrar/ocultar senha
      togglePassword.addEventListener('click', () => {
        const type = senhaInput.type === 'password' ? 'text' : 'password';
        senhaInput.type = type;
        togglePassword.innerHTML = type === 'password' 
          ? '<i class="fas fa-eye"></i>' 
          : '<i class="fas fa-eye-slash"></i>';
      });

      // Sanitizar input (prevenir XSS)
      function sanitizeInput(input) {
        const div = document.createElement('div');
        div.textContent = input;
        return div.innerHTML.trim();
      }

      // Validar email
      function validarEmail(email) {
        const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return regex.test(email);
      }

      // Verificar se est√° bloqueado
      function verificarBloqueio() {
        const agora = Date.now();
        if (tentativas >= MAX_TENTATIVAS && (agora - ultimaTentativa) < TEMPO_BLOQUEIO) {
          const tempoRestante = Math.ceil((TEMPO_BLOQUEIO - (agora - ultimaTentativa)) / 60000);
          errorMsg.textContent = `Muitas tentativas falhas. Tente novamente em ${tempoRestante} minuto(s).`;
          errorMsg.style.display = 'block';
          btnLogin.disabled = true;
          return true;
        }
        if ((agora - ultimaTentativa) >= TEMPO_BLOQUEIO) {
          tentativas = 0;
          localStorage.setItem('loginAttempts', '0');
        }
        btnLogin.disabled = false;
        return false;
      }

      // Verificar bloqueio ao carregar
      verificarBloqueio();

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMsg.style.display = 'none';

        if (verificarBloqueio()) return;

        const email = sanitizeInput(emailInput.value);
        const senha = senhaInput.value;

        // Valida√ß√µes
        if (!validarEmail(email)) {
          errorMsg.textContent = 'Por favor, insira um email v√°lido.';
          errorMsg.style.display = 'block';
          return;
        }

        if (senha.length < 6) {
          errorMsg.textContent = 'A senha deve ter no m√≠nimo 6 caracteres.';
          errorMsg.style.display = 'block';
          return;
        }

        btnLogin.disabled = true;
        btnLogin.textContent = 'ENTRANDO...';

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest"
            },
            body: JSON.stringify({ email, senha }),
          });

          if (!res.ok) {
            tentativas++;
            ultimaTentativa = Date.now();
            localStorage.setItem('loginAttempts', tentativas.toString());
            localStorage.setItem('lastAttempt', ultimaTentativa.toString());

            const erro = await res.json();
            errorMsg.textContent = erro.erro || 'Email ou senha inv√°lidos!';
            errorMsg.style.display = 'block';
            
            if (tentativas >= MAX_TENTATIVAS) {
              verificarBloqueio();
            } else {
              errorMsg.textContent += ` (${MAX_TENTATIVAS - tentativas} tentativa(s) restante(s))`;
            }
            return;
          }

          // Login bem-sucedido - resetar tentativas
          localStorage.removeItem('loginAttempts');
          localStorage.removeItem('lastAttempt');

          const usuario = await res.json();
          
          // Remover senha antes de armazenar
          delete usuario.senha;
          
          // Criar sess√£o segura
          const sessao = {
            ...usuario,
            timestamp: Date.now(),
            expiresIn: 24 * 60 * 60 * 1000 // 24 horas
          };
          
          localStorage.setItem("usuarioLogado", JSON.stringify(sessao));
          window.location.href = "index.html";
        } catch (err) {
          console.error(err);
          errorMsg.textContent = 'Erro na conex√£o com o servidor.';
          errorMsg.style.display = 'block';
        } finally {
          btnLogin.disabled = false;
          btnLogin.textContent = 'ENTRAR';
        }
      });
    </script>
  </body>
</html>
